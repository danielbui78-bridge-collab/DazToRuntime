// DAZ Studio version 4.16.0.3 filetype DAZ Script

/////////////////////////////
// Localize-JobPool
/////////////////////////////
//
// Converts all DTU files in a jobpool to Aboslute Paths.
//
function RelativeToAbsolute( sDtuPath )
{

	var oContentMgr = App.getContentMgr();
	print("Reading DTU file: [" + sDtuPath + "]");
	var oFile = new DzFile( sDtuPath );
	if ( !oFile.exists() )
	{
		print("DTU file does not exist: " + sDtuPath);
		return false;
	}
	if ( !oFile.open(DzFile.ReadOnly) )
	{
		print("Unable to open DTU file for reading: " + sDtuPath);
		return false;
	}
	var sDtuContents = oFile.read()
	oFile.close()
	if (!sDtuContents)
	{
		print("Error reading DTU file: " + sDtuPath);
		return false;
	}
	var oDTU = {}
	try
	{
		oDTU = JSON.parse(sDtuContents);
	}
	catch (e)
	{
		oDTU = false;
	}
	if (!oDTU)
	{
		print("Error parsing DTU file. May be invalid JSON format: " + sDtuPath);
		return false;
	}

	var arrKeys = Object.keys(oDTU);
//	for (i = 0; i < arrKeys.length; i++)
//	{
//		print("Key[" + i + "]: " + arrKeys[i]);
//	}

	var MaterialList = oDTU["Materials"];
//	print ("Material Keys: " + Object.keys(MaterialList[0]))
	for (i = 0; i < MaterialList.length; i++)
	{
		var matObj = MaterialList[i];
//		print("Material[" + i + "]: " + matObj["Material Name"])
		var propList = matObj["Properties"];
		for (j = 0; j < propList.length; j++)
		{
			var property = propList[j];
			if (property["Texture"] != "")
			{
//				print ("Name: " + property["Name"]);
//				print ("Texture: " + property["Texture"]);
				var sTextureName = property["Texture"];
				var sFullPath = oContentMgr.findFile(sTextureName)
				if (sTextureName != sFullPath)
				{
					print("Texture renamed: " + sFullPath)
				}
				property["Texture"] = sFullPath
			}
		}
	}

	var newContents = JSON.stringify(oDTU)
	oFile.open(DzFile.WriteOnly)
	oFile.write(newContents);
	oFile.close()

	return true;
}

function ProcessJobFile ( sJobFile )
{
	print("Reading jobfile: " + sJobFile);
	var oFile = new DzFile( sJobFile );
	if ( !oFile.exists() )
	{
		print("Jobpool file does not exist.");
		return false;
	}
	if ( !oFile.open(DzFile.ReadOnly) )
	{
		print("Unable to open jobpool file for reading.");
		return false;
	}

	var sJobLine = ""
	while (sJobLine = oFile.readLine().replace("\n",""))
	{
		if (!sJobLine)
		{
			break;
		}
		print ("Localizing: " + sJobLine)
		if (RelativeToAbsolute(sJobLine) == false)
		{
			print("Failed to localize DTU: " + sJobLine);
		}
	}
	oFile.close()

	return true;

}

function main()
{
	//var aArgList = ["C:/CustomRoot/autoexec-jobpool.txt"]
	//var aArgList = App.scriptArgs;
	var aArgList = getArguments()
	var nArgCount = aArgList.length;

	if (nArgCount == 0)
	{
		print();
		print("Usage: Localize-JobPool.dsa <jobpool-file>");
		print();
		return;
	}

	print("DEBUG: num args:" + nArgCount + ", arglist is: " + aArgList)

	for (i = 0; i < nArgCount; i++)
	{
		sJobfile = aArgList[i];
		if (ProcessJobFile(sJobfile) == false)
		{
			print("Convert jobpool failed: " + sJobfile);
		}
	}
}

//RelativeToAbsolute("C:/CustomRoot/CustomFolder/CustomAsset.dtu")
main();
